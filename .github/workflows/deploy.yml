name: CD - Continuous Deployment

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.fruitfulplanet.example.com
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}
          
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/hpa.yaml
          kubectl apply -f k8s/ingress.yaml
          
      - name: Wait for deployment
        run: |
          kubectl rollout status deployment/fruitfulplanet-app -n fruitfulplanet --timeout=5m
          
      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Add your smoke tests here
          
      - name: Notify ecosystem of staging deployment
        env:
          GITHUB_TOKEN: ${{ secrets.ECOSYSTEM_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”” Notifying ecosystem of staging deployment..."
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/heyns1000/codenest/dispatches" \
            -d "{\"event_type\":\"deployment_staging\",\"client_payload\":{\"repo\":\"$GITHUB_REPOSITORY\",\"sha\":\"$GITHUB_SHA\"}}" \
            || true
          
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/heyns1000/omnigrid/dispatches" \
            -d "{\"event_type\":\"deployment_staging\",\"client_payload\":{\"repo\":\"$GITHUB_REPOSITORY\",\"sha\":\"$GITHUB_SHA\"}}" \
            || true
          
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: production
      url: https://fruitfulplanet.example.com
    needs: []
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_PRODUCTION }}
          
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/hpa.yaml
          kubectl apply -f k8s/ingress.yaml
          
      - name: Wait for deployment
        run: |
          kubectl rollout status deployment/fruitfulplanet-app -n fruitfulplanet --timeout=10m
          
      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Add your smoke tests here
          
      - name: Notify ecosystem of production deployment
        env:
          GITHUB_TOKEN: ${{ secrets.ECOSYSTEM_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”” Notifying ecosystem of production deployment..."
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/heyns1000/codenest/dispatches" \
            -d "{\"event_type\":\"deployment_production\",\"client_payload\":{\"repo\":\"$GITHUB_REPOSITORY\",\"sha\":\"$GITHUB_SHA\",\"tag\":\"${GITHUB_REF#refs/tags/}\"}}" \
            || true
          
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/heyns1000/omnigrid/dispatches" \
            -d "{\"event_type\":\"deployment_production\",\"client_payload\":{\"repo\":\"$GITHUB_REPOSITORY\",\"sha\":\"$GITHUB_SHA\",\"tag\":\"${GITHUB_REF#refs/tags/}\"}}" \
            || true
          
      - name: Notify deployment
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Production deployment ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure()
    environment:
      name: production
    steps:
      - name: Notify ecosystem of rollback
        env:
          GITHUB_TOKEN: ${{ secrets.ECOSYSTEM_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”” Notifying ecosystem of deployment rollback..."
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/heyns1000/codenest/dispatches" \
            -d "{\"event_type\":\"deployment_rollback\",\"client_payload\":{\"repo\":\"$GITHUB_REPOSITORY\",\"reason\":\"deployment_failed\"}}" \
            || true
          
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/heyns1000/omnigrid/dispatches" \
            -d "{\"event_type\":\"deployment_rollback\",\"client_payload\":{\"repo\":\"$GITHUB_REPOSITORY\",\"reason\":\"deployment_failed\"}}" \
            || true
      
      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_PRODUCTION }}
          
      - name: Rollback deployment
        run: |
          kubectl rollout undo deployment/fruitfulplanet-app -n fruitfulplanet
          kubectl rollout status deployment/fruitfulplanet-app -n fruitfulplanet
